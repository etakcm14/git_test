This is complicated but not too hard. 